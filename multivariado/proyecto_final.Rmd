---
title: "Métodos Cuantitativos para la Gestión y Análisis de Datos en Organizaciones"
subtitle: "Estudio del consumo de alimentos por paises y su Huella de Carbono"
author: "Rodrigo Serrano"
date: "Mayo de 2021"
output: 
  pdf_document:
    # keep_tex: true
    highlight: default
    includes:
      in_header: ../preamble.tex
header-includes:
  - \usepackage{titling}
  - \pretitle{\begin{center}
    \includegraphics[width=5in,height=3in]{../encabezado.jpg}\LARGE\\
    \bigskip
    }
urlcolor: blue
---

\

## Métodos de Análisis Multivariado {.unlisted .unnumbered}

## Docentes: Silvina Del Duca y Silvia Vietri {.unlisted .unnumbered}

\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, fig.align = 'center', fig.showtext = T)
library(ggplot2)
library(tidyverse)
thematic::thematic_rmd(
  bg = "#ffffff", fg = '#4a4a4a', accent = '#e9832d', font = 'Roboto'
  )
```

Inicializamos las librerias necesarias para los distintos estudios

```{r libraries}
library(tidyverse) # Manipulacion de datos
library(tidytuesdayR) # Extraccion de datos
library(psych) # Analisis Factorial
library(corrplot) # Grafico de Correlaciones
library(gt) # Creacion de tablas

```

## Datos

Los datos son obtenidos con el paquete **`tidytuesday`**, el cual facilita datasets semanalmente para la practica y ejemplificacion de visualizaciones y modelos en el lenguaje R. En este caso utilizaremos el dataset de la semana 8 del año 2020. Este dataset es un estudio originalmente realizado por [nu3](https://www.nu3.de/blogs/nutrition/food-carbon-footprint-index-2018) y expone dos variables registradas en 130 paises:

- **consumption:** cantidad (en kg) de alimento anual producido para consumo por persona
- **co2_emmission:** emision (en kg) anual de CO2 por persona

```{r datos_init, eval = F}
# Carga de datos
tuesdata <- tidytuesdayR::tt_load(2020, week = 8)

food_consumption <- tuesdata$food_consumption %>% 
  mutate(food_category = word(food_category, 1)) # Limpiamos los nombres de los tipos de alimentos
```

```{r datos_csv, echo = F}
food_consumption <- read_csv('data/food_consumption.csv')
```

Podemos ver por ejemplo los datos de Argentina:

```{r descriptive_argentina}
food_consumption %>%
  filter(country == 'Argentina') %>%
  gt::gt()
```

## Analisis Descriptivo

Primero veamos los valores faltantes y la distribucion de las variables

```{r descriptives_skim}
which(is.na(food_consumption))

food_consumption %>%
  pivot_longer(-c(country, food_category)) %>%
  ggplot(aes(value)) +
  geom_density() +
  facet_wrap(~name) +
  labs(x = '')
```

Se observa que la data no tiene valores nulos o perdidos en ningun campo y que ambas variables metricas (consumption y co2_emmission) estan sesgadas hacia la derecha. Veamos ahora la distribucion de las variables por tipo de alimento

```{r descriptive_boxplot}
food_consumption %>%
  pivot_longer(c(consumption, co2_emmission)) %>%
  ggplot(aes(x = value, y = food_category)) +
  geom_boxplot() +
  facet_wrap(~name, scales = 'free_x', ncol = 2) +
  labs(x = '', y = '')

```

Se puede observar que el tipo de alimento con mayor emision de CO2 es la carne de res, sin embargo la de mayor cantidad de produccion es la leche de vaca, seguido por el trigo y el arroz

Como bien se sabe, los alimentos de origen animal tienen una huella de carbono mucho mayor a los alimentos de origen no animal. Vemoas que esto se cumpla en el dataset

```{r descriptive_source}
# Creamos el campo source para identificar si el food_category es de origen animal o no-animal
food_consumption <- food_consumption %>% 
  mutate(
    source = if_else(
      food_category %in% c('Wheat', 'Rice', 'Nuts', 'Soybeans'), 'non-animal', 'animal'
      )
  )

food_consumption %>%
  group_by(source) %>%
  summarise(
    consumption = sum(consumption),
    co2_emmission = sum(co2_emmission),
    .groups = 'drop'
    ) %>%
  pivot_longer(-source) %>%
  ggplot(aes(x = value, y = source)) +
  geom_col() +
  facet_wrap(~name, scales = 'free_x', ncol = 2) +
  labs(x = '')
```

Veamos ahora la dispercion de los individuos por emision de CO2 y consumo

```{r descriptives_countries}
food_consumption %>%
  group_by(country) %>%
  summarise(
    consumption = sum(consumption),
    co2_emmission = sum(co2_emmission),
    .groups = 'drop'
  ) %>%
  ggplot(aes(x = consumption, y = co2_emmission, label = country)) +
  geom_label(size = 2.8)
```

Se observa que existe una aproximada relacion lineal entre la cantidad total de alimento producido y la cantidad de emision de CO2. Mientras mayor es la produccion mas es la emision de CO2. Tambien se puede notar que los paises con mayor consumo son en su mayoria paises desarrollados, mientras que su contraparte son en su mayoria paises pertenecientes al continente Africano.

## Analisis Factorial

Para aplicar el analisis factorial se trabajara solo con la variable **`consumption`**. Se formara un set de datos donde los individuos seran los paises y las variables a asociar seran los tipos de alimentos. Comenzemos inspeccionando la correlacion entre las variables

```{r af_pivot}
country_consumption <- food_consumption %>%
  select(-co2_emmission, -source) %>% # Excluimos la variable de emision de CO2
  pivot_wider(names_from = food_category, values_from = consumption) # Pivoteamos los datos

# Matriz de Correlacion
consumption_cor <- country_consumption %>%
  select(-country) %>%
  cor()

consumption_cor %>% 
  corrplot::corrplot(
    type = 'lower', diag = F, order = 'hclust', tl.srt = 20, tl.col = 'black',
    col = colorRampPalette(c("#04a494", "#ffffff", "#e9832d"))(20)
    )

```

Se puede observar que existe una correlacion positiva entre los tipos de alimentos Cerdo, Leche y Huevo. Mientras que el tipo de alimento Arroz tiene en su mayoria, correlaciones negativas.

Pocedemos ahora a verificar el test de Barlett y KMO

```{r af_tests}
consumption_cor %>% psych::cortest.bartlett(n = nrow(country_consumption))
country_consumption %>% select(-country) %>% KMO()
```

Se puede observar que el p-valor para el test de Barlett tiende a 0, por lo que podemos rechazar la hipotesis nula y afirmar que existe correlacion entre las variables. Igualmente, el coeficiente KMO es mayor a .7, lo que indica que es factible efectuar el analisis factorial en el set de datos, con las correlaciones existentes entre las variables.

Vamos ahora a verificar el numero de factores a incluir en el analisis factorial, que vendra dado por el numero de autovalores mayores a 1 arrojados por la matriz de autovalores y autovectores

```{r af_svd}
svd(consumption_cor)$d

fit_pa <- principal(
  consumption_cor, nfactors = 3, rotate = 'varimax', n.obs = nrow(country_consumption)
  )

fit_pa
```


Podemos observar que excepto para Poultry y Beef, la comunalidad es mayor al 50% para el resto de las variables, lo que significa que los factores comunes contienen mas de la mitad de la varianza en cada una de las variables. Los tres factores retenidos representan 60% de la varianza para los factores comunes y 40% para factores especificos. Por su lado, la componente 1 tiene una representacion del 50% mientras que las otras 26% y 23%. Veamos ahora la agrupacion arrojada por en analisis factorial.

```{r af_coord}
fit_pa$loadings[1:11,] %>% 
  as.data.frame() %>% 
  rownames_to_column('food_type') %>% 
  ggplot(aes(x = RC1, y = RC2, label = food_type, fill = RC3)) +
  geom_hline(yintercept = 0, color = 'gray') +
  geom_vline(xintercept = 0, color = 'gray') +
  geom_label(color = 'white')

```

Segun las agrupaciones observadas, podemos decir que los paises que consumen productos derivados de la vaca tambien consumen mucho trigo y carne de aves. De igual manera ocurre con los paises que consumen pescado y productos derivados de las nueces, de hecho estos dos productos son los unicos que mantienen una relacion cercana en las tres componentes. Por otro lado vemos que existe una relacion cercana entre la carne de Cerdo y Huevo

## Analisis de Clusters

El analisis de cluster se realizara sobre la variable **`consumption`** y lo que se busca es agrupar los paises de acuerdo al tipo de consumo distribuido en los 11 alimentos. Para esto creamos la matriz de distancias con el metodo Euclidiano. Tambien creamos una funcion que facilita la creacion de los clusters

```{r cluster_init}
consumption_distance <- country_consumption %>%
  column_to_rownames('country') %>%
  scale() %>%
  dist(method = "euclidean")

cut_hc <- function(.hc, .k = 3, column_id = 'country'){
  
  # .hc: Hierarchical Cluster object to cut
  # .k: number of cluster to form
  # column_id: name of individuals column
  
  cutree(.hc, k = .k) %>%
    as.data.frame() %>%
    rownames_to_column(var = column_id) %>% 
    rename(cluster = '.') %>% 
    mutate(cluster = as_factor(cluster))
}
```

Para la eleccion del metodo de agrupamiento primero observamos la distribucion por cluster para cada uno de los metodos. La eleccion del numero de cluster se realizo de manera discrecional. 

```{r cluster_preview}
list(
  list(
    single = 'single', complete = 'complete', centroid = 'centroid', ward = 'ward.D2'
  ),
  list(consumption_distance)
) %>% 
  pmap_df(.id = 'method', function(.method, .df){
     .df %>% 
      hclust(method = .method) %>% 
      cut_hc(.k = 3) %>% 
      count(cluster)
  }) %>% 
  pivot_wider(names_from = method, values_from = n) %>% 
  gt::gt() %>% 
  gt::tab_header(title = 'Cantidad de paises en cada cluster por Metodo', subtitle = '-')
```

Podemos ver que el unico metodo que logra formar clusters equilibrados es el metodo de Ward, los demas clusters asignan practicamente la totalidad de los paises al primer cluster. El metodo de Ward consiste en la minimizacion de la varianza dentro de los clusters.

```{r cluster_ward}
hc <- consumption_distance %>% 
  hclust(method = "ward.D2")
clusters <- cut_hc(hc, .k = 3)
```

No se grafica el dendograma ya que la cantidad de invididuos es muy elevada y seria dificil extraer alguna conclusion. Veamos la dispersion por consumo y emision de CO2 con las agrupaciones

```{r cluster_scatter}
food_consumption %>% 
  group_by(country) %>% 
  summarise(
    consumption = sum(consumption),
    co2_emmission = sum(co2_emmission),
    .groups = 'drop'
  ) %>% 
  left_join(clusters, by = 'country') %>% 
  ggplot(aes(x = consumption, y = co2_emmission, fill = cluster, label = country)) +
  geom_label(color = 'white', size = 2.8) +
  scale_fill_manual(values = c("#e9832d", "#04a494", "#4a4a4a"))
```

Podemos ver que los clusters formados logran estratificar los paises en alta, media y baja emision de CO2. Tambien podemos ver el comportamiento de los clusters en el consumo por tipo de origen de los alimentos

```{r}
food_consumption %>% 
  group_by(country, source) %>% 
  summarise(
    co2_emmission = sum(co2_emmission),
    .groups = 'drop'
  ) %>% 
  pivot_wider(names_from = source, values_from = co2_emmission) %>% 
  left_join(clusters, by = 'country') %>% 
  ggplot(aes(x = animal, y = `non-animal`, fill = cluster, label = country)) +
  geom_label(color = 'white', size = 2.8) +
  scale_fill_manual(values = c("#e9832d", "#04a494", "#4a4a4a"))
```

Podemos observar que el cluster 1 esta formado por los paises que tienen alto consumo de alimentos de origen animal y bajo consumo de alimentos de origen no animal. El grupo 2 esta conformado por paises que tienen consumo equilibrado para ambos tipos de origen de alimento. Finalmente el grupo 3 estaria conformado por paises con bajo consumo de alimentos de origen animal

